# item 45 스트림은 주의해서 사용하라

---

### 스트림 API 개념 

- 다량의 데이터 처리 작업을 돕고자 추가됨 (순차든 병렬이든)

- 추상 개념 중 핵심
  - 1. 스트림(stream)은 데이터 원소의 유한 혹은 무한 시퀀스를 뜻한다.
  - 2. 스트림 파이프라인(stream pipeline)은 이 원소들로 수행하는 연산 단계를 표현하는 개념이다.

- 스트림의 원소들은 어디로부터든 올 수 있다. (컬렉션, 배열, 파일, 정규표현식 패턴 매처, 난수 생성기, int, long, double...)
  
- 스트림 파이프라인은 소스 스트림에서 시작해 종단 연산으로 끝나며, 그 사이에 하나 이상의 중간 연산이 있을 수 있다.
  - 각 중간 연산은 스트림을 어떠한 방식으로 변환한다.
  - 중간 연산들은 모두 한 스트림을 다른 스트림으로 변환한다.
    - 필터링 하거나 맵 하거나
  - 종단 연산은 마지막 중간 연산이 내놓은 스트림에 최후의 연산을 가한다.
    - 컬렉션에 담거나 하나만 선택하거나
  
- 스트림 파이프라인은 지연 평가(lazy evaluation)된다. 평가는 종단 연산이 호출될 때 이뤄지며 종단 연산에 쓰이지 않는 데이터 원소는 계산에 쓰이지 않는다.
  - 지연 평가가 무한 스트림을 다룰 수 있게 해주는 열쇠다.
  - 종단 연산이 없는 스트림 파이프라인은 아무 일도 하지 않는 명령어인 no-op과 같으니 종단 연산을 빼먹는 일은 없도록 하자.
  
- 스트림 API는 메서드 연쇄를 지원하는 플루언트 API다.
  - 파이프라인을 구성하는 모든 호출을 연결하여 단 하나의 표현식으로 완성할 수 있다. 
    - 여러 개 파이프라인을 연결 해 표현식 하나로 만들 수도 있다.
  
- 기본적으로 스트림 파이프라인은 순차적으로 수행된다. parallel 메서드를 호출해주기만 하면 되나 효과를 볼 수 있는 상황은 많지 않다.

- 스트림을 제대로 사용하면 프로그램이 짧고 깔끔해지지만 잘못 사용하면 읽기 어렵고 유지보수도 힘들어진다.

- 람다 매개변수의 이름은 주의해서 정해야 한다. 람다에서는 타입 이름을 자주 생략하므로 매개변수 이름을 잘 지어야 스트림 파이프라인의 가독성이 유지된다.

- char용 스트림을 지원하지 않기 때문에 chars()를 반환하는 스트림의 원소는 char가 아닌 int 값이다.
```java
"Hello world".chars().forEach(System.out::println);
// 721011081081113211911111410810033

"Hello world".chars().forEach(x -> System.out.print((char) x));
// "Hello world" 명시적으로 형변환을 해 주어야 한다.
```
- 따라서 char 값들을 처리할 때는 스트림을 삼가는 편이 낫다.

- 기존 코드는 스트림을 사용하도록 리팩터링하되, 새 코드가 더 나아 보일 때만 반영하자. (가독성 유지보수 측면에서의 손해가 있을 수 있다.)

### 함수 객체로는 할 수 없지만 코드블록으로는 할 수 있는 일들

- 코드 블록에서는 범위 안의 지역변수를 읽고 수정할 수 있다.
  - but 람다에서는 final이거나 사실상 final인 변수만 읽을 수 있고 지역 변수를 수정하는 건 불가능하다. 
    - [****** ‘람다식에서 참조하는 외부 지역 변수는 final 혹은 effectively final 이어야한다.’](https://vagabond95.me/posts/lambda-with-final/)
    - [밸둥형](https://www.baeldung.com/java-lambda-effectively-final-local-variables#:~:text=The%20basic%20reason%20this%20won,modify%20the%20start%20method%20parameter.)
  - 코드 블록에서는 return 문을 사용해 메서드에서 빠져나가거나 break, continue 문으로 블록 바깥의 반복문을 종료하거나 반복을 한 번 건너뛸 수 있다.
  - 또한 메서드 선언에 명시된 검사 예외를 던질 수 있다. 
  - 람다에서는 아무것도 할 수 없다.
  
### 스트림에 안성맞춤인 일

- 원소들의 시퀀스를 일관되게 변환한다.
- 원소들의 시퀀스를 필터링한다.
- 원소들의 시퀀스를 하나의 연산을 사용해 결합한다.
- 원소들의 시퀀스를 컨렉션에 모은다.
- 원소들의 시퀀스에서 특정 조건을 만족하는 원소를 찾는다.


### 스트림으로 처리하기 어려운 일 

- 한 데이터가 파이프라인의 여러 단계를 통과할 때 데이터의 각 단계에서의 값들에 동시에 접근하기는 어렵다. (1 -> 2 -> 3 -> 4 통과했을 때 2, 3을 접근하기 어렵다는 말)
  - 스트림 파이프라인은 일단 한 값을 다른 값에 매핑하고 나면 원래의 값은 잃는 구조이기 때문이다.
  - 원래 값과 새로운 값의 쌍을 저장하는 객체를 사용해 매핑하는 우회 방법이 있으나 만족스러운 해법은 아니다.
  
- 스트림을 반환하는 메서드의 이름은 원소의 정체를 알려주는 복수 명사를 쓰기를 강력히 추천 -> 스트림 파이프라인의 가독성이 크게 좋아질 것이다.
```java
static Stream<BigInteger> primes() {
    return Stream.iterate(TWO, BigInteger::nextProbablePrime);
}
```

우리 예제
```
inventory
spaceStockSearcher -> Stream<SpaceStockDtoV1> stream
```

```
inbound
AtomicBoolean InboundCommandApplication
```